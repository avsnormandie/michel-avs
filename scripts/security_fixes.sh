#!/bin/bash
# Security fixes for GK41 - AVS Technologies
# Generated by brain_security_audit.py
# Run with: sudo bash security_fixes.sh

set -e

echo "ðŸ”’ Application des corrections de securite..."

# 1. Restreindre sudo NOPASSWD
echo "[1/6] Restriction sudo NOPASSWD..."
cat > /etc/sudoers.d/michel << 'SUDOERS'
# Michel: NOPASSWD limit to essential commands
michel ALL=(ALL) NOPASSWD: /bin/systemctl, /usr/bin/systemctl, /usr/bin/apt, /usr/bin/apt-get, /usr/bin/journalctl, /usr/bin/python3, /usr/bin/fail2ban-client, /usr/bin/unattended-upgrades, /usr/sbin/ufw
# Require password for everything else
michel ALL=(ALL:ALL) ALL
SUDOERS
chmod 440 /etc/sudoers.d/michel
visudo -c && echo "  âœ… sudoers OK" || { echo "  âŒ sudoers INVALIDE"; exit 1; }

# 2. Fix SSH tunnel StrictHostKeyChecking
echo "[2/6] Fix SSH tunnel..."
if [ -f /etc/systemd/system/ssh-tunnel.service ]; then
    sed -i 's/StrictHostKeyChecking=no/StrictHostKeyChecking=accept-new/' /etc/systemd/system/ssh-tunnel.service
    systemctl daemon-reload
    systemctl restart ssh-tunnel
    echo "  âœ… SSH tunnel corrige"
else
    echo "  âš ï¸ ssh-tunnel.service non trouve"
fi

# 3. Disable X11Forwarding
echo "[3/6] Desactivation X11Forwarding..."
sed -i 's/^X11Forwarding yes/X11Forwarding no/' /etc/ssh/sshd_config
systemctl reload sshd
echo "  âœ… X11Forwarding desactive"

# 4. Install and configure fail2ban
echo "[4/6] Installation fail2ban..."
apt install -y fail2ban
cat > /etc/fail2ban/jail.local << 'F2B'
[DEFAULT]
bantime = 3600
findtime = 600
maxretry = 5

[sshd]
enabled = true
port = 7912
filter = sshd
logpath = /var/log/auth.log
maxretry = 3
F2B
systemctl enable fail2ban
systemctl restart fail2ban
echo "  âœ… fail2ban configure (port 7912)"

# 5. Install unattended-upgrades
echo "[5/6] Installation mises a jour auto..."
apt install -y unattended-upgrades apt-listchanges
cat > /etc/apt/apt.conf.d/20auto-upgrades << 'UU'
APT::Periodic::Update-Package-Lists "1";
APT::Periodic::Unattended-Upgrade "1";
APT::Periodic::AutocleanInterval "7";
UU
echo "  âœ… unattended-upgrades configure"

# 6. Install audit tools
echo "[6/6] Installation outils audit..."
apt install -y nmap ssh-audit lynis
echo "  âœ… Outils installes"

echo ""
echo "ðŸŽ‰ Corrections appliquees ! Relancez l'audit pour verifier."
echo "   python3 brain_security_audit.py audit"

